connection node_2;
connection node_1;
connection node_1;
CREATE TABLE t1(a int not null primary key, b int, c int) engine=InnoDB;
INSERT INTO t1 VALUES (1,1,1),(2,2,1),(3,1,1),(4,2,2),(5,2,2),(6,1,1),(7,2,2),(8,1,1),(9,1,1);
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1b;
SET GLOBAL debug_dbug = "d,sync.before_lock_rec_unlock";
connect node_1d, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1d;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE t1 SET c = 5 WHERE b = 2;;
connection node_1b;
SET SESSION DEBUG_SYNC='now WAIT_FOR sync.before_lock_rec_unlock_reached';
connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1c;
begin;
UPDATE t1 SET c = 10 WHERE a = 3;;
connection node_1b;
SET GLOBAL debug_dbug = "";
SET DEBUG_SYNC = "now SIGNAL signal.before_lock_rec_unlock";
connection node_1d;
connection node_1c;
ERROR HY000: Lost connection to MySQL server during query
connection node_1b;
SET DEBUG_SYNC = "RESET";
SELECT * FROM t1;
a	b	c
1	1	1
2	2	1
3	1	1
4	2	2
5	2	2
6	1	1
7	2	2
8	1	1
9	1	1
DROP TABLE t1;
disconnect node_1b;
disconnect node_1c;
disconnect node_1d;
connection node_1;
CREATE TABLE t1(a int not null primary key, b int, c int) engine=InnoDB;
INSERT INTO t1 VALUES (1,1,1),(2,2,1),(3,1,1),(4,2,2),(5,2,2),(6,1,1),(7,2,2),(8,1,1),(9,1,1);
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1b;
SET GLOBAL debug_dbug = "d,sync.before_lock_rec_unlock";
connect node_1d, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1d;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE t1 SET c = 5 WHERE b = 2;;
connection node_1b;
SET SESSION DEBUG_SYNC='now WAIT_FOR sync.before_lock_rec_unlock_reached';
connection node_1b;
SET GLOBAL debug_dbug = "";
SET DEBUG_SYNC = "now SIGNAL signal.before_lock_rec_unlock";
connection node_1d;
ERROR HY000: Lost connection to MySQL server during query
connection node_1b;
SET DEBUG_SYNC = "RESET";
connection node_1;
SELECT * FROM t1;
a	b	c
1	1	1
2	2	1
3	1	1
4	2	2
5	2	2
6	1	1
7	2	2
8	1	1
9	1	1
DROP TABLE t1;
disconnect node_1b;
disconnect node_1d;
connection node_1;
CREATE TABLE t1(a int not null primary key, b int, c int) engine=InnoDB;
INSERT INTO t1 VALUES (1,1,1),(2,2,1),(3,1,1),(4,2,2),(5,2,2),(6,1,1),(7,2,2),(8,1,1),(9,1,1);
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1b;
SET GLOBAL debug_dbug = "d,sync.before_lock_rec_unlock";
connect node_1d, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1d;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE t1 SET c = 5 WHERE b = 2;;
connection node_1b;
SET SESSION DEBUG_SYNC='now WAIT_FOR sync.before_lock_rec_unlock_reached';
connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1c;
begin;
UPDATE t1 SET c = 10 WHERE a = 3;;
connection node_1b;
SET GLOBAL debug_dbug = "";
SET DEBUG_SYNC = "now SIGNAL signal.before_lock_rec_unlock";
connection node_1c;
ERROR HY000: Lost connection to MySQL server during query
connection node_1d;
ERROR HY000: Lost connection to MySQL server during query
connection node_1b;
SET DEBUG_SYNC = "RESET";
connection node_1;
SELECT * FROM t1;
a	b	c
1	1	1
2	2	1
3	1	1
4	2	2
5	2	2
6	1	1
7	2	2
8	1	1
9	1	1
DROP TABLE t1;
disconnect node_1b;
disconnect node_1c;
disconnect node_1d;
connection node_1;
CREATE TABLE t1(a int not null primary key, b int, c int) engine=InnoDB;
INSERT INTO t1 VALUES (1,1,1),(2,2,1),(3,1,1),(4,2,2),(5,2,2),(6,1,1),(7,2,2),(8,1,1),(9,1,1);
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1b;
SET GLOBAL debug_dbug = "d,sync.before_lock_rec_unlock";
connect node_1d, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1d;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE t1 SET c = 5 WHERE b = 2;;
connection node_1b;
SET SESSION DEBUG_SYNC='now WAIT_FOR sync.before_lock_rec_unlock_reached';
connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1c;
begin;
UPDATE t1 SET c = 10 WHERE a = 3;;
connection node_1b;
SET GLOBAL debug_dbug = "";
SET DEBUG_SYNC = "now SIGNAL signal.before_lock_rec_unlock";
connection node_1c;
ERROR HY000: Lost connection to MySQL server during query
connection node_1d;
ERROR HY000: Lost connection to MySQL server during query
connection node_1b;
SET DEBUG_SYNC = "RESET";
connection node_1;
SELECT * FROM t1;
a	b	c
1	1	1
2	2	1
3	1	1
4	2	2
5	2	2
6	1	1
7	2	2
8	1	1
9	1	1
DROP TABLE t1;
disconnect node_1b;
disconnect node_1c;
disconnect node_1d;
connection node_1;
CREATE TABLE t1(a int not null primary key, b int, c int) engine=InnoDB;
INSERT INTO t1 VALUES (1,1,1),(2,2,1),(3,1,1),(4,2,2),(5,2,2),(6,1,1),(7,2,2),(8,1,1),(9,1,1);
connect node_1b, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1b;
SET GLOBAL debug_dbug = "d,sync.before_lock_rec_unlock";
connect node_1d, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1d;
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;
BEGIN;
UPDATE t1 SET c = 5 WHERE b = 2;;
connection node_1b;
SET SESSION DEBUG_SYNC='now WAIT_FOR sync.before_lock_rec_unlock_reached';
connect node_1c, 127.0.0.1, root, , test, $NODE_MYPORT_1;
connection node_1c;
ALTER TABLE t1 ADD KEY b(b), ALGORITHM=INPLACE, LOCK=EXCLUSIVE;;
connection node_1b;
SET GLOBAL debug_dbug = "";
SET DEBUG_SYNC = "now SIGNAL signal.before_lock_rec_unlock";
connection node_1d;
connection node_1b;
SET DEBUG_SYNC = "RESET";
connection node_1c;
SHOW CREATE TABLE t1;
Table	Create Table
t1	CREATE TABLE `t1` (
  `a` int(11) NOT NULL,
  `b` int(11) DEFAULT NULL,
  `c` int(11) DEFAULT NULL,
  PRIMARY KEY (`a`),
  KEY `b` (`b`)
) ENGINE=InnoDB DEFAULT CHARSET=latin1
connection node_1;
SELECT * FROM t1;
a	b	c
1	1	1
2	2	1
3	1	1
4	2	2
5	2	2
6	1	1
7	2	2
8	1	1
9	1	1
DROP TABLE t1;
disconnect node_1b;
